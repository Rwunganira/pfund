{% extends "base.html" %}

{% block content %}

<section class="table-section">
    <div class="table-header">
        <div>
            <h2>Sub-activities for {{ activity.code or activity.proposed_activity or 'activity' }}</h2>
            <p class="table-hint">
                Break down this activity into smaller sub-activities with a responsible person, timeline and status.
            </p>
        </div>
    </div>

    <div class="table-wrapper">
        <table class="compact-table">
            <thead>
            <tr>
                <th style="width: 40%;">Sub-activity</th>
                <th style="width: 18%;">Responsible</th>
                <th style="width: 18%;">Timeline</th>
                <th style="width: 12%;">Status</th>
                {% if current_user.role == 'admin' %}
                <th style="width: 12%;">Actions</th>
                {% endif %}
            </tr>
            </thead>
            <tbody>
            {% for sa in sub_activities %}
                <tr>
                    <td>{{ sa.title }}</td>
                    <td>{{ sa.responsible or "-" }}</td>
                    <td>{{ sa.timeline or "-" }}</td>
                    <td>
                        {% set st = sa.status or 'pending' %}
                        <span class="status-badge status-{{ st }}">
                            {{ st.replace('-', ' ').title() }}
                        </span>
                    </td>
                    {% if current_user.role == 'admin' %}
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <a href="{{ url_for('activity.edit_subactivity', sub_id=sa.id) }}"
                               class="button small"
                               style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">
                                Edit
                            </a>
                            {% if current_user.email == admin_email %}
                            <form method="post"
                                  action="{{ url_for('activity.delete_subactivity', sub_id=sa.id) }}"
                                  style="display: inline;"
                                  onsubmit="return confirm('Are you sure you want to delete this sub-activity?');">
                                <button type="submit" class="button small danger"
                                        style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">
                                    Delete
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                    {% endif %}
                </tr>
            {% else %}
                <tr>
                    <td colspan="{% if current_user.role == 'admin' %}5{% else %}4{% endif %}" class="empty">
                        No sub-activities have been defined for this activity yet.
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <form method="post" class="upload-form" style="margin-top: 1.5rem;">
        <h3>Add a new sub-activity</h3>
        <div class="field-group">
            <label for="title">Sub-activity</label>
            <textarea id="title" name="title" rows="2" required
                      placeholder="Describe the sub-activity"></textarea>
        </div>
        <div class="field-group">
            <label for="responsible">Responsible</label>
            <input id="responsible" name="responsible" type="text" placeholder="Person / team">
        </div>
        <div class="field-group">
            <label for="timeline">Timeline</label>
            <input id="timeline" name="timeline" type="text" placeholder="e.g. Q2 2026, by 31 July">
        </div>
        <div class="field-group">
            <label for="status">Status</label>
            <select id="status" name="status" required>
                <option value="pending" selected>Pending</option>
                <option value="in-progress">In progress</option>
                <option value="completed">Completed</option>
                <option value="canceled">Canceled</option>
            </select>
        </div>
        <div class="form-actions">
            <button type="submit" class="primary">Add sub-activity</button>
            <a href="{{ url_for('activity.index') }}" class="button secondary">Back to dashboard</a>
        </div>
    </form>
</section>

{% endblock %}


