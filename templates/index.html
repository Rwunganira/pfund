{% extends "base.html" %}

{% block content %}
<section class="dashboard">
    <div>
        <div class="hero-header">
            <div>
                <h1>PFUND Implementation Dashboard</h1>
                <p>Monitor project activities, budgets and delivery partners across the portfolio.</p>
            </div>
        </div>

        <div class="cards">
            <div class="card card-total">
                <div class="card-label">Total activities</div>
                <div class="card-value">{{ summary.total_activities or 0 }}</div>
            </div>
            <div class="card card-budget">
                <div class="card-label">Total budget</div>
                <div class="card-value">{{ "%.0f"|format(summary.total_budget or 0) }}</div>
            </div>
            <div class="card card-used">
                <div class="card-label">Budget used</div>
                <div class="card-value">{{ "%.0f"|format(summary.total_used or 0) }}</div>
            </div>
            <div class="card card-progress">
                <div class="card-label">Avg. progress</div>
                <div class="card-value">{{ "%.0f"|format(summary.avg_progress or 0) }}%</div>
            </div>
        </div>
    </div>

    <div class="status-summary">
        <h2>Status overview</h2>
        <table>
            <thead>
            <tr>
                <th>Status</th>
                <th>Activities</th>
                <th>Total budget</th>
            </tr>
            </thead>
            <tbody>
            {% for s in status_rows %}
                {% set status_name = s.status or "Unknown" %}
                <tr class="status-row status-{{ status_name|lower|replace(' ', '-')|replace('/', '-') }}">
                    <td>
                        <span class="status-pill status-{{ status_name|lower|replace(' ', '-')|replace('/', '-') }}">
                            {{ status_name }}
                        </span>
                    </td>
                    <td class="num">{{ s.count }}</td>
                    <td class="num">{{ "%.0f"|format(s.budget or 0) }}</td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="3" class="empty">No data yet.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<section class="filters">
    <form method="get">
        <div class="field-group">
            <label for="status">Status</label>
            <select name="status" id="status">
                <option value="">All</option>
                {% for s in ["Planned", "In Progress", "Completed", "On Hold", "Cancelled"] %}
                    <option value="{{ s }}" {% if status_filter == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="field-group">
            <label for="implementing_entity">Implementing Entity</label>
            <select name="implementing_entity" id="implementing_entity">
                <option value="">All</option>
                {% for e in entities %}
                    <option value="{{ e }}" {% if entity_filter == e %}selected{% endif %}>{{ e }}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit">Apply filters</button>
        <a href="{{ url_for('activity.download_activities', status=status_filter, implementing_entity=entity_filter) }}"
           class="secondary download-btn">Download CSV</a>
    </form>

    {% if current_user.role == 'admin' %}
        <form method="post" action="{{ url_for('activity.upload_excel') }}" enctype="multipart/form-data" class="upload-form">
            <div class="field-group">
                <label for="file">Upload Excel to populate activities</label>
                <input type="file" id="file" name="file" accept=".xlsx,.xls">
            </div>
            <button type="submit">Upload</button>
        </form>

        <form method="post" action="{{ url_for('activity.delete_all_activities') }}" onsubmit="return confirm('Delete ALL activities? This cannot be undone.');">
            <button type="submit" class="danger-all">Delete all activities</button>
        </form>
    {% endif %}
</section>

<section class="table-section">
    <div class="table-header">
        <h2>Activities ({{ activities|length }})</h2>
        <p class="table-hint">Click <strong>View Details</strong> to see full information including notes and initial activity</p>
    </div>
    <div class="table-wrapper">
        <table class="compact-table">
            <thead>
            <tr>
                <th>Code</th>
                <th>Proposed Activity</th>
                <th>Entity</th>
                <th>Status</th>
                <th>Progress</th>
                <th>Total Budget</th>
                <th>Budget Used</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for a in activities %}
                <tr data-activity-id="{{ a.id }}">
                    <td><strong>{{ a.code or '-' }}</strong></td>
                    <td>
                        <span class="truncate-text" title="{{ a.proposed_activity }}">
                            {{ a.proposed_activity or '-' }}
                        </span>
                    </td>
                    <td>{{ a.implementing_entity or '-' }}</td>
                    <td>
                        {% set status_name = a.status or "Unknown" %}
                        <span class="status-pill status-{{ status_name|lower|replace(' ', '-')|replace('/', '-') }}">
                            {{ status_name }}
                        </span>
                    </td>
                    <td>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress" style="width: {{ a.progress or 0 }}%"></div>
                            </div>
                            <span class="progress-label">{{ a.progress or 0 }}%</span>
                        </div>
                    </td>
                    <td class="num">{{ "%.0f"|format(a.budget_total or 0) }}</td>
                    <td class="num budget-used">{{ "%.0f"|format(a.budget_used or 0) }}</td>
                    <td class="actions">
                        <button class="btn-view-details" onclick="openDetailsModal({{ a.id }})" title="View full details">
                            View Details
                        </button>
                        {% if current_user.role == 'admin' %}
                            <a href="{{ url_for('activity.edit_activity', activity_id=a.id) }}" class="btn-edit">Edit</a>
                            <form action="{{ url_for('activity.delete_activity', activity_id=a.id) }}" method="post"
                                  onsubmit="return confirm('Delete this activity?');" style="display: inline;">
                                <button type="submit" class="btn-delete">Delete</button>
                            </form>
                        {% endif %}
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="8" class="empty">No activities yet. Click "New Activity" to add one.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<!-- Details Modal -->
<div id="detailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Activity Details</h2>
            <button class="modal-close" onclick="closeDetailsModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Content will be populated by JavaScript -->
        </div>
        <div class="modal-footer">
            {% if current_user.role == 'admin' %}
                <a id="editLink" href="#" class="btn-primary">Edit Activity</a>
            {% endif %}
            <button onclick="closeDetailsModal()" class="btn-secondary">Close</button>
        </div>
    </div>
</div>

<script>
// Activity data for modal (embedded in page)
const activityData = {
    {% for a in activities %}
    {{ a.id }}: {
        code: {{ a.code|tojson }},
        initial_activity: {{ a.initial_activity|tojson }},
        proposed_activity: {{ a.proposed_activity|tojson }},
        notes: {{ a.notes|tojson }},
        implementing_entity: {{ a.implementing_entity|tojson }},
        delivery_partner: {{ a.delivery_partner|tojson }},
        results_area: {{ a.results_area|tojson }},
        category: {{ a.category|tojson }},
        budget_year1: {{ a.budget_year1 or 0 }},
        budget_year2: {{ a.budget_year2 or 0 }},
        budget_year3: {{ a.budget_year3 or 0 }},
        budget_total: {{ a.budget_total or 0 }},
        budget_used: {{ a.budget_used or 0 }},
        status: {{ a.status|tojson }},
        progress: {{ a.progress or 0 }},
        edit_url: {{ url_for('activity.edit_activity', activity_id=a.id)|tojson }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

function openDetailsModal(activityId) {
    const data = activityData[activityId];
    if (!data) return;

    const modal = document.getElementById('detailsModal');
    const modalBody = document.getElementById('modalBody');
    const editLink = document.getElementById('editLink');

    // Build the details HTML
    modalBody.innerHTML = `
        <div class="detail-grid">
            <div class="detail-section">
                <h3>Basic Information</h3>
                <div class="detail-item">
                    <label>Code:</label>
                    <span>${data.code || '-'}</span>
                </div>
                <div class="detail-item">
                    <label>Status:</label>
                    <span class="status-pill status-${(data.status || 'Unknown').toLowerCase().replace(/[ /]/g, '-')}">${data.status || 'Unknown'}</span>
                </div>
                <div class="detail-item">
                    <label>Progress:</label>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress" style="width: ${data.progress || 0}%"></div>
                        </div>
                        <span class="progress-label">${data.progress || 0}%</span>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <h3>Activity Description</h3>
                <div class="detail-item full-width">
                    <label>Initial Activity:</label>
                    <div class="detail-text">${data.initial_activity || '<em>Not specified</em>'}</div>
                </div>
                <div class="detail-item full-width">
                    <label>Proposed Activity:</label>
                    <div class="detail-text">${data.proposed_activity || '<em>Not specified</em>'}</div>
                </div>
            </div>

            <div class="detail-section">
                <h3>Organizational Details</h3>
                <div class="detail-item">
                    <label>Implementing Entity:</label>
                    <span>${data.implementing_entity || '-'}</span>
                </div>
                <div class="detail-item">
                    <label>Delivery Partner:</label>
                    <span>${data.delivery_partner || '-'}</span>
                </div>
                <div class="detail-item">
                    <label>Results Area:</label>
                    <span>${data.results_area || '-'}</span>
                </div>
                <div class="detail-item">
                    <label>Category:</label>
                    <span>${data.category || '-'}</span>
                </div>
            </div>

            <div class="detail-section">
                <h3>Budget Information</h3>
                <div class="budget-grid">
                    <div class="budget-item">
                        <label>Year 1:</label>
                        <span class="num">${data.budget_year1.toLocaleString()}</span>
                    </div>
                    <div class="budget-item">
                        <label>Year 2:</label>
                        <span class="num">${data.budget_year2.toLocaleString()}</span>
                    </div>
                    <div class="budget-item">
                        <label>Year 3:</label>
                        <span class="num">${data.budget_year3.toLocaleString()}</span>
                    </div>
                    <div class="budget-item budget-total">
                        <label>Total Budget:</label>
                        <span class="num">${data.budget_total.toLocaleString()}</span>
                    </div>
                    <div class="budget-item budget-used">
                        <label>Budget Used:</label>
                        <span class="num">${data.budget_used.toLocaleString()}</span>
                    </div>
                    <div class="budget-item budget-remaining">
                        <label>Remaining:</label>
                        <span class="num">${(data.budget_total - data.budget_used).toLocaleString()}</span>
                    </div>
                </div>
            </div>

            <div class="detail-section full-width">
                <h3>Notes</h3>
                <div class="detail-item full-width">
                    <div class="notes-content">${data.notes ? data.notes.replace(/\\n/g, '<br>') : '<em class="muted">No notes available</em>'}</div>
                </div>
            </div>
        </div>
    `;

    if (editLink) {
        editLink.href = data.edit_url;
    }

    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeDetailsModal() {
    const modal = document.getElementById('detailsModal');
    modal.style.display = 'none';
    document.body.style.overflow = '';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('detailsModal');
    if (event.target === modal) {
        closeDetailsModal();
    }
}

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeDetailsModal();
    }
});
</script>
{% endblock %}


