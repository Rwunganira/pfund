{% extends "base.html" %}

{% block content %}

<section class="dashboard">
    <div>
        <div class="hero-header">
            <div>
                <h1>PFUND Implementation Dashboard</h1>
                <p>Monitor project activities, budgets and delivery partners across the portfolio.</p>
            </div>
        </div>

        {# Compute overall budget execution (used / total) in percent #}
        {% set exec_pct = (summary.total_used / summary.total_budget * 100) if summary.total_budget else 0 %}

        <div class="cards">
            <div class="card card-total">
                <div class="card-label">Total activities</div>
                <div class="card-value">{{ summary.total_activities or 0 }}</div>
            </div>
            <div class="card card-budget">
                <div class="card-label">Total budget</div>
                <div class="card-value">{{ "%.0f"|format(summary.total_budget or 0) }}</div>
            </div>
            <div class="card card-used">
                <div class="card-label">Budget used</div>
                <div class="card-value">{{ "%.0f"|format(summary.total_used or 0) }}</div>
            </div>
            <div class="card card-progress">
                <div class="card-label">% budget execution</div>
                <div class="card-value">{{ "%.0f"|format(exec_pct or 0) }}%</div>
            </div>
        </div>
    </div>

    <div class="status-summary">
        <h2>Status overview</h2>
        <table>
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Activities</th>
                    <th>Total budget</th>
                </tr>
            </thead>
            <tbody>
            {% for s in status_rows %}
                {% set status_name = s.status or "Unknown" %}
                <tr class="status-row status-{{ status_name|lower|replace(' ', '-')|replace('/', '-') }}">
                    <td>
                        <span class="status-pill status-{{ status_name|lower|replace(' ', '-')|replace('/', '-') }}">
                            {{ status_name }}
                        </span>
                    </td>
                    <td class="num">{{ s.count }}</td>
                    <td class="num">{{ "%.0f"|format(s.budget or 0) }}</td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="3" class="empty">No data yet.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<section class="filters">
    <form method="get">
        <div class="field-group" style="min-width: 220px;">
            <label for="q">Search</label>
            <input
                type="text"
                id="q"
                name="q"
                value="{{ search_query or '' }}"
                placeholder="Search by code, activity, entity…">
        </div>

        <div class="field-group">
            <label for="status">Status</label>
            <div class="multiselect-wrapper">
                <div class="multiselect-display" data-target="status">
                    <span class="multiselect-placeholder">All</span>
                    <span class="multiselect-arrow">▼</span>
                </div>
                <div class="multiselect-dropdown" id="status-dropdown">
                    <input type="text" class="multiselect-search" placeholder="Search status..." data-filter="status">
                    <div class="multiselect-options" id="status-options">
                        {% for s in ["Planned", "In Progress", "Completed", "On Hold", "Cancelled"] %}
                            <label class="multiselect-option">
                                <input type="checkbox" name="status" value="{{ s }}" 
                                       {% if s in (status_filter.split(',') if status_filter else []) %}checked{% endif %}>
                                <span>{{ s }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="field-group">
            <label for="implementing_entity">Implementing Entity</label>
            <div class="multiselect-wrapper">
                <div class="multiselect-display" data-target="implementing_entity">
                    <span class="multiselect-placeholder">All</span>
                    <span class="multiselect-arrow">▼</span>
                </div>
                <div class="multiselect-dropdown" id="implementing_entity-dropdown">
                    <input type="text" class="multiselect-search" placeholder="Search entities..." data-filter="implementing_entity">
                    <div class="multiselect-options" id="implementing_entity-options">
                        {% for e in entities %}
                            <label class="multiselect-option">
                                <input type="checkbox" name="implementing_entity" value="{{ e }}" 
                                       {% if e in (entity_filter.split(',') if entity_filter else []) %}checked{% endif %}>
                                <span>{{ e }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="field-group">
            <label for="category">Activity type</label>
            <div class="multiselect-wrapper">
                <div class="multiselect-display" data-target="category">
                    <span class="multiselect-placeholder">All</span>
                    <span class="multiselect-arrow">▼</span>
                </div>
                <div class="multiselect-dropdown" id="category-dropdown">
                    <input type="text" class="multiselect-search" placeholder="Search categories..." data-filter="category">
                    <div class="multiselect-options" id="category-options">
                        {% for c in categories %}
                            <label class="multiselect-option">
                                <input type="checkbox" name="category" value="{{ c }}" 
                                       {% if c in (category_filter.split(',') if category_filter else []) %}checked{% endif %}>
                                <span>{{ c }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="field-group">
            <label for="results_area">Results area</label>
            <div class="multiselect-wrapper">
                <div class="multiselect-display" data-target="results_area">
                    <span class="multiselect-placeholder">All</span>
                    <span class="multiselect-arrow">▼</span>
                </div>
                <div class="multiselect-dropdown" id="results_area-dropdown">
                    <input type="text" class="multiselect-search" placeholder="Search results areas..." data-filter="results_area">
                    <div class="multiselect-options" id="results_area-options">
                        {% for r in results_areas %}
                            <label class="multiselect-option">
                                <input type="checkbox" name="results_area" value="{{ r }}" 
                                       {% if r in (results_filter.split(',') if results_filter else []) %}checked{% endif %}>
                                <span>{{ r }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <button type="submit">Apply filters</button>
        <a href="#" 
           id="download-link"
           class="secondary download-btn"
           onclick="updateDownloadLink(); return false;">Download CSV</a>
    </form>

    {% if current_user.role == 'admin' %}
        <form method="post" action="{{ url_for('activity.upload_excel') }}" enctype="multipart/form-data" class="upload-form">
            <div class="field-group">
                <label for="file">Upload Excel to populate activities</label>
                <input type="file" id="file" name="file" accept=".xlsx,.xls">
            </div>
            <button type="submit">Upload</button>
        </form>

        <form method="post" action="{{ url_for('activity.delete_all_activities') }}" onsubmit="return confirm('Delete ALL activities? This cannot be undone.');">
            <button type="submit" class="danger-all">Delete all activities</button>
        </form>
    {% endif %}
</section>

<section class="table-section">
    <div class="table-header">
        <h2>Activities ({{ activities|length }})</h2>
        <p class="table-hint">Click a row or <strong>View Details</strong> to see full information.</p>
    </div>

    <div class="table-wrapper">
        <table class="compact-table">
            <thead>
                <tr>
                    <th>Activity Type</th>
                    <th>Proposed Activity</th>
                    <th>Entity</th>
                    <th>Status</th>
                    <th>Progress</th>
                    <th>Total Budget</th>
                    <th>Budget Used</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>

            {% for a in activities %}
                <tr class="activity-row"
                    data-activity-id="{{ a.id }}"
                    tabindex="0"
                    aria-label="View activity {{ a.category or a.proposed_activity }}">

                    <td><strong>{{ a.category or '-' }}</strong></td>

                    <td>
                        <span class="truncate-text" title="{{ a.proposed_activity }}">
                            {{ a.proposed_activity or '-' }}
                        </span>
                    </td>

                    <td>{{ a.implementing_entity or '-' }}</td>

                    <td>
                        {% set status_name = a.status or "Unknown" %}
                        <span class="status-pill status-{{ status_name|lower|replace(' ', '-')|replace('/', '-') }}">
                            {{ status_name }}
                        </span>
                    </td>

                    <td>
                        {% set exec_pct = a.exec_pct if a.exec_pct is defined else 0 %}
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress" style="width: {{ exec_pct }}%"></div>
                            </div>
                            <span class="progress-label">{{ exec_pct }}%</span>
                        </div>
                    </td>

                    <td class="num">{{ "%.0f"|format(a.budget_total or 0) }}</td>
                    <td class="num budget-used">{{ "%.0f"|format(a.budget_used or 0) }}</td>

                    <td class="actions">
                        <button
                            class="btn-view-details"
                            onclick="event.stopPropagation(); event.preventDefault(); openDetailsModal({{ a.id }});"
                            type="button">
                            View Details
                        </button>

                        {% if current_user.role == 'admin' %}
                            {% if a.id and activity_urls.get(a.id) %}
                                {# Preserve current filters by passing the full path as `next` #}
                                <a href="{{ activity_urls[a.id].edit_url }}?next={{ request.full_path|urlencode }}"
                                   class="btn-edit"
                                   onclick="event.stopPropagation();">Edit</a>

                                <form action="{{ activity_urls[a.id].delete_url }}"
                                      method="post"
                                      style="display:inline;"
                                      onsubmit="event.stopPropagation(); return confirm('Delete this activity?');">
                                    <button class="btn-delete" type="submit">Delete</button>
                                </form>

                                <a href="{{ url_for('activity.manage_subactivities', activity_id=a.id) }}"
                                   class="btn-edit"
                                   style="margin-left: 0.25rem;"
                                   onclick="event.stopPropagation();">
                                    Sub-activities
                                </a>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>

            {% else %}
                <tr>
                    <td colspan="8" class="empty">No activities yet.</td>
                </tr>
            {% endfor %}

            </tbody>
        </table>
    </div>
</section>

<!-- Details Modal -->
<div id="detailsModal" class="modal">
    <div class="modal-content">

        <div class="modal-header">
            <h2>Activity Details</h2>
            <button class="modal-close" onclick="closeDetailsModal()">&times;</button>
        </div>

        <div class="modal-body" id="modalBody"></div>

        <div class="modal-footer">
            {% if current_user.role == 'admin' %}
                <a id="editLink" href="#" class="btn-primary">Edit Activity</a>
            {% endif %}
            <button onclick="closeDetailsModal()" class="btn-secondary">Close</button>
        </div>

    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Activity data for modal (embedded in page)
var activityData = {};
console.log('Initializing activityData. activities_with_urls length:', {{ activities_with_urls|length if activities_with_urls else 0 }});
{% if activities_with_urls and activities_with_urls|length > 0 %}
    {% for item in activities_with_urls %}
        {% set a = item.activity %}
        {% if a and a.id is defined and a.id %}
        // Store with both string and number keys for compatibility
        try {
            var actId = {{ a.id }};
            var actData = {
                code: {{ (a.code or '')|tojson }},
                initial_activity: {{ (a.initial_activity or '')|tojson }},
                proposed_activity: {{ (a.proposed_activity or '')|tojson }},
                notes: {{ (a.notes or '')|tojson }},
                implementing_entity: {{ (a.implementing_entity or '')|tojson }},
                delivery_partner: {{ (a.delivery_partner or '')|tojson }},
                results_area: {{ (a.results_area or '')|tojson }},
                category: {{ (a.category or '')|tojson }},
            budget_year1: Number({{ a.budget_year1|default('0')|tojson }}) || 0,
            budget_year2: Number({{ a.budget_year2|default('0')|tojson }}) || 0,
            budget_year3: Number({{ a.budget_year3|default('0')|tojson }}) || 0,
            budget_total: Number({{ a.budget_total|default('0')|tojson }}) || 0,
            budget_used: Number({{ a.budget_used|default('0')|tojson }}) || 0,
            status: {{ (a.status or 'Unknown')|tojson }},
            progress: Number({{ (a.exec_pct if a.exec_pct is defined else 0)|tojson }}) || 0,
                edit_url: {{ (item.edit_url or '#')|tojson }}
            };
            // Store with both number and string keys
            activityData[actId] = actData;
            activityData[String(actId)] = actData;
        } catch(e) {
            console.error('Error loading activity {{ a.id }}:', e);
        }
        {% endif %}
    {% endfor %}
{% else %}
    console.warn('No activities_with_urls data available!');
{% endif %}

// Debug: Log how many activities were loaded
console.log('Loaded activity data for', Object.keys(activityData).length, 'activities');
console.log('Activity IDs (first 10):', Object.keys(activityData).slice(0, 10));
console.log('Sample activity (first ID):', activityData[Object.keys(activityData)[0]]);
// Test if ID 638 exists
if (activityData[638] || activityData['638']) {
    console.log('✓ Activity 638 found in data');
} else {
    console.warn('✗ Activity 638 NOT found in data');
    console.log('All IDs:', Object.keys(activityData).map(k => parseInt(k)).sort((a,b) => a-b).slice(0, 20));
}

// Make function globally accessible - define it before DOMContentLoaded
function openDetailsModal(activityId) {
    // Convert to number and string for lookup
    const numId = parseInt(activityId);
    const strId = String(activityId);
    
    console.log('openDetailsModal called with ID:', activityId);
    console.log('Looking for:', numId, 'or', strId);
    console.log('Available activity keys:', Object.keys(activityData));
    console.log('First few keys:', Object.keys(activityData).slice(0, 5));
    
    // Try number key first, then string key
    let data = activityData[numId] || activityData[strId];
    
    if (!data) {
        // Try the original value as-is
        data = activityData[activityId];
    }
    
    if (!data) {
        console.error('Activity data not found for ID:', activityId);
        console.error('Tried keys:', numId, strId, activityId);
        console.error('Available keys (first 10):', Object.keys(activityData).slice(0, 10));
        console.error('Sample activity data:', activityData[Object.keys(activityData)[0]]);
        alert('Activity details not available. Activity ID: ' + activityId + '. Please check console for details.');
        return;
    }
    
    console.log('Found activity data:', data);

    const modal = document.getElementById('detailsModal');
    const modalBody = document.getElementById('modalBody');
    const editLink = document.getElementById('editLink');
    
    if (!modal || !modalBody) {
        console.error('Modal elements not found!');
        alert('Modal elements not found. Please refresh the page.');
        return;
    }

    // Build the details HTML
    modalBody.innerHTML = `
        <div class="detail-grid">
            <div class="detail-section">
                <h3>Basic Information</h3>
                <div class="detail-item">
                    <label>Activity Type:</label>
                    <span>${data.category || '-'}</span>
                </div>
                <div class="detail-item">
                    <label>Status:</label>
                    <span class="status-pill status-${(data.status || 'Unknown').toLowerCase().replace(/[ /]/g, '-')}">${data.status || 'Unknown'}</span>
                </div>
                <div class="detail-item">
                    <label>Progress:</label>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress" style="width: ${data.progress || 0}%"></div>
                        </div>
                        <span class="progress-label">${data.progress || 0}%</span>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <h3>Activity Description</h3>
                <div class="detail-item full-width">
                    <label>Initial Activity:</label>
                    <div class="detail-text">${data.initial_activity || '<em>Not specified</em>'}</div>
                </div>
                <div class="detail-item full-width">
                    <label>Proposed Activity:</label>
                    <div class="detail-text">${data.proposed_activity || '<em>Not specified</em>'}</div>
                </div>
            </div>

            <div class="detail-section">
                <h3>Organizational Details</h3>
                <div class="detail-item">
                    <label>Implementing Entity:</label>
                    <span>${data.implementing_entity || '-'}</span>
                </div>
                <div class="detail-item">
                    <label>Delivery Partner:</label>
                    <span>${data.delivery_partner || '-'}</span>
                </div>
                <div class="detail-item">
                    <label>Results Area:</label>
                    <span>${data.results_area || '-'}</span>
                </div>
            </div>

            <div class="detail-section">
                <h3>Budget Information</h3>
                <div class="budget-grid">
                    <div class="budget-item">
                        <label>Year 1:</label>
                        <span class="num">${(Number(data.budget_year1) || 0).toLocaleString()}</span>
                    </div>
                    <div class="budget-item">
                        <label>Year 2:</label>
                        <span class="num">${(Number(data.budget_year2) || 0).toLocaleString()}</span>
                    </div>
                    <div class="budget-item">
                        <label>Year 3:</label>
                        <span class="num">${(Number(data.budget_year3) || 0).toLocaleString()}</span>
                    </div>
                    <div class="budget-item budget-total">
                        <label>Total Budget:</label>
                        <span class="num">${(Number(data.budget_total) || 0).toLocaleString()}</span>
                    </div>
                    <div class="budget-item budget-used">
                        <label>Budget Used:</label>
                        <span class="num">${(Number(data.budget_used) || 0).toLocaleString()}</span>
                    </div>
                    <div class="budget-item budget-remaining">
                        <label>Remaining:</label>
                        <span class="num">${((Number(data.budget_total) || 0) - (Number(data.budget_used) || 0)).toLocaleString()}</span>
                    </div>
                </div>
            </div>

            <div class="detail-section full-width">
                <h3>Notes</h3>
                <div class="detail-item full-width">
                    <div class="notes-content">${data.notes ? data.notes.replace(/\\n/g, '<br>') : '<em class="muted">No notes available</em>'}</div>
                </div>
            </div>
        </div>
    `;

    if (editLink) {
        editLink.href = data.edit_url;
    }

    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeDetailsModal() {
    const modal = document.getElementById('detailsModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }
}

// Test if function is accessible
console.log('openDetailsModal function defined:', typeof openDetailsModal);

// Make table rows clickable
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up event listeners');
    // Also add click handlers to View Details buttons directly
    const viewButtons = document.querySelectorAll('.btn-view-details');
    console.log('Found', viewButtons.length, 'View Details buttons');
    viewButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            const row = this.closest('.activity-row');
            if (row) {
                const activityId = parseInt(row.getAttribute('data-activity-id'));
                console.log('Button clicked, activity ID:', activityId);
                if (activityId) {
                    openDetailsModal(activityId);
                }
            }
        });
    });
    
    const rows = document.querySelectorAll('.activity-row');
    console.log('Found', rows.length, 'activity rows');
    rows.forEach(row => {
        row.addEventListener('click', function(e) {
            // Don't open modal if clicking on buttons/links/forms
            if (e.target.closest('button, a, form, input, select')) {
                console.log('Click on button/link/form, ignoring row click');
                return;
            }
            const activityId = parseInt(this.getAttribute('data-activity-id'));
            console.log('Row clicked, activity ID:', activityId);
            if (activityId) {
                openDetailsModal(activityId);
            }
        });

        // Add keyboard support
        row.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const activityId = parseInt(this.getAttribute('data-activity-id'));
                if (activityId) {
                    openDetailsModal(activityId);
                }
            }
        });
    });

    // Close modal when clicking outside
    const modal = document.getElementById('detailsModal');
    if (modal) {
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeDetailsModal();
            }
        });
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeDetailsModal();
        }
    });

    // Multi-select functionality
    function initMultiSelect() {
        const wrappers = document.querySelectorAll('.multiselect-wrapper');
        
        wrappers.forEach(wrapper => {
            const display = wrapper.querySelector('.multiselect-display');
            const dropdown = wrapper.querySelector('.multiselect-dropdown');
            const searchInput = wrapper.querySelector('.multiselect-search');
            const options = wrapper.querySelectorAll('.multiselect-option');
            const checkboxes = wrapper.querySelectorAll('input[type="checkbox"]');
            const targetName = display.getAttribute('data-target');
            
            // Update display text based on selected items
            function updateDisplay() {
                const selected = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                
                const placeholder = display.querySelector('.multiselect-placeholder');
                const tagsContainer = display.querySelector('.multiselect-tags');
                
                if (selected.length === 0) {
                    if (placeholder) placeholder.textContent = 'All';
                    if (tagsContainer) tagsContainer.innerHTML = '';
                } else {
                    if (placeholder) placeholder.textContent = '';
                    if (!tagsContainer) {
                        const newTags = document.createElement('div');
                        newTags.className = 'multiselect-tags';
                        display.insertBefore(newTags, display.querySelector('.multiselect-arrow'));
                    }
                    const tags = display.querySelector('.multiselect-tags');
                    tags.innerHTML = selected.map(value => {
                        const label = Array.from(options).find(opt => 
                            opt.querySelector('input').value === value
                        )?.querySelector('span')?.textContent || value;
                        return `<span class="multiselect-tag">
                            ${label}
                            <span class="multiselect-tag-remove" data-value="${value}">×</span>
                        </span>`;
                    }).join('');
                    
                    // Add click handlers to remove buttons
                    tags.querySelectorAll('.multiselect-tag-remove').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const value = btn.getAttribute('data-value');
                            const checkbox = Array.from(checkboxes).find(cb => cb.value === value);
                            if (checkbox) {
                                checkbox.checked = false;
                                updateDisplay();
                            }
                        });
                    });
                }
            }
            
            // Toggle dropdown
            display.addEventListener('click', (e) => {
                e.stopPropagation();
                const isActive = dropdown.classList.contains('active');
                
                // Close all other dropdowns
                document.querySelectorAll('.multiselect-dropdown').forEach(d => {
                    if (d !== dropdown) d.classList.remove('active');
                });
                document.querySelectorAll('.multiselect-display').forEach(d => {
                    if (d !== display) d.classList.remove('active');
                });
                
                dropdown.classList.toggle('active', !isActive);
                display.classList.toggle('active', !isActive);
                
                if (!isActive && searchInput) {
                    setTimeout(() => searchInput.focus(), 10);
                }
            });
            
            // Search functionality
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    options.forEach(option => {
                        const text = option.querySelector('span').textContent.toLowerCase();
                        if (text.includes(query)) {
                            option.classList.remove('hidden');
                        } else {
                            option.classList.add('hidden');
                        }
                    });
                });
                
                // Prevent form submission on Enter
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                    }
                });
            }
            
            // Update display when checkboxes change
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateDisplay);
            });
            
            // Initialize display
            updateDisplay();
        });
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.multiselect-wrapper')) {
                document.querySelectorAll('.multiselect-dropdown').forEach(d => {
                    d.classList.remove('active');
                });
                document.querySelectorAll('.multiselect-display').forEach(d => {
                    d.classList.remove('active');
                });
            }
        });
    }
    
    initMultiSelect();
    
    // Update download link with current filter values
    function updateDownloadLink() {
        const form = document.querySelector('.filters form');
        const formData = new FormData(form);
        const params = new URLSearchParams();
        
        // Add all filter parameters
        formData.getAll('status').forEach(val => params.append('status', val));
        formData.getAll('implementing_entity').forEach(val => params.append('implementing_entity', val));
        formData.getAll('category').forEach(val => params.append('category', val));
        formData.getAll('results_area').forEach(val => params.append('results_area', val));
        const searchQuery = formData.get('q');
        if (searchQuery) {
            params.append('q', searchQuery);
        }
        
        const downloadUrl = '{{ url_for("activity.download_activities") }}?' + params.toString();
        window.location.href = downloadUrl;
    }
    
    // Also update on page load if filters are present
    const downloadLink = document.getElementById('download-link');
    if (downloadLink) {
        // Set initial href (will be updated by JavaScript on click)
        downloadLink.href = '{{ url_for("activity.download_activities") }}';
    }
});
</script>
{% endblock %}

