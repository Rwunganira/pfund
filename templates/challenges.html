{% extends "base.html" %}

{% block content %}

<section class="table-section">
           <div class="table-header">
               <div>
                   <h2>Follow-up items and actions</h2>
                   <p class="table-hint">
                       Track key follow-up items, agreed actions, responsible leads and timelines.
                   </p>
               </div>
               <div class="table-actions">
                   <a href="{{ url_for('activity.download_challenges') }}"
                      class="button secondary"
                      style="margin-right: 0.5rem;">
                       Download follow-up CSV
                   </a>
                   {% if current_user.role == 'admin' %}
                       <form method="post"
                             action="{{ url_for('activity.upload_challenges') }}"
                             enctype="multipart/form-data"
                             class="upload-form"
                             style="display: inline-flex; gap: 0.5rem; align-items: center;">
                           <label for="challenges_file" style="margin: 0;">Upload follow-up Excel</label>
                           <input type="file"
                                  id="challenges_file"
                                  name="file"
                                  accept=".xlsx,.xls"
                                  style="max-width: 220px;">
                           <button type="submit" class="button small">Upload</button>
                       </form>
                   {% endif %}
               </div>
           </div>

    <div class="table-wrapper">
        <table class="compact-table">
            <thead>
            <tr>
                <th style="width: 25%;">Item</th>
                <th style="width: 25%;">Agreed action</th>
                <th style="width: 10%;">Responsible</th>
                <th style="width: 10%;">Timeline</th>
                <th style="width: 10%;">Status</th>
                {% if current_user.role == 'admin' %}
                <th style="width: 10%;">Actions</th>
                {% endif %}
            </tr>
            </thead>
            <tbody>
            {% for c in challenges %}
                <tr>
                    <td>{{ c.challenge }}</td>
                    <td>{{ c.action }}</td>
                    <td>{{ c.responsible or "-" }}</td>
                    <td>{{ c.timeline or "-" }}</td>
                    <td>
                        <span class="status-badge status-{{ c.status or 'pending' }}">
                            {{ (c.status or 'pending').title() }}
                        </span>
                    </td>
                    {% if current_user.role == 'admin' %}
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <a href="{{ url_for('activity.edit_challenge', challenge_id=c.id, next=request.full_path) }}" 
                               class="button small" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Edit</a>
                            {% if current_user.email == admin_email %}
                            <form method="post" 
                                  action="{{ url_for('activity.delete_challenge', challenge_id=c.id) }}" 
                                  style="display: inline;"
                                  onsubmit="return confirm('Are you sure you want to delete this challenge?');">
                                <input type="hidden" name="next" value="{{ request.full_path }}">
                                <button type="submit" class="button small danger" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">Delete</button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                    {% endif %}
                </tr>
            {% else %}
                <tr>
                    <td colspan="{% if current_user.role == 'admin' %}6{% else %}5{% endif %}" class="empty">
                        No follow-up items have been recorded yet.
                        {% if current_user.role == 'admin' %}
                            Use the form below to add the first one.
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    {% if current_user.role == 'admin' %}
        <form method="post"
              action="{{ url_for('activity.add_challenge') }}"
              class="upload-form"
              style="margin-top: 1rem;">
            <input type="hidden" name="next" value="{{ request.full_path }}">
            <div class="field-group">
                <label for="challenge">New item</label>
                <textarea id="challenge" name="challenge" rows="2"
                          placeholder="Describe the follow-up item"></textarea>
            </div>
            <div class="field-group">
                <label for="action">Agreed action</label>
                <textarea id="action" name="action" rows="2"
                          placeholder="Describe what will be done to address it"></textarea>
            </div>
            <div class="field-group">
                <label for="responsible">Responsible</label>
                <input id="responsible" name="responsible" type="text" placeholder="Person / team">
            </div>
            <div class="field-group">
                <label for="timeline">Timeline</label>
                <input id="timeline" name="timeline" type="text" placeholder="e.g. Q1 2026, by 30 June">
            </div>
            <div class="field-group">
                <label for="status">Status</label>
                <select id="status" name="status" required>
                    <option value="pending" selected>Pending</option>
                    <option value="completed">Completed</option>
                    <option value="canceled">Canceled</option>
                </select>
            </div>
            <button type="submit">Add challenge</button>
        </form>
    {% endif %}
</section>

{% endblock %}


